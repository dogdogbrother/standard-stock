name: Update Used Money

on:
  # å®šæ—¶æ‰§è¡Œï¼šå·¥ä½œæ—¥æ¯å¤©ä¸‹åˆ 3:01ï¼ˆä¸­å›½æ—¶é—´ = UTC+8ï¼‰
  # 15:01 CST = 07:01 UTC
  schedule:
    - cron: '1 7 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”ï¼ŒUTC 07:01
  
  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get current time
        id: time
        run: |
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "å½“å‰æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
      
      - name: Call Supabase Edge Function
        run: |
          # ä¸´æ—¶æµ‹è¯•ï¼šä½¿ç”¨ç¡¬ç¼–ç  URL
          SUPABASE_URL="https://qixncbgvrkfjxopqqpiz.supabase.co"
          
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
          echo "æµ‹è¯• URL: ${SUPABASE_URL}/functions/v1/update-used-money"
          echo ""
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/update-used-money" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ è¯·æ±‚å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… usedMoney æ›´æ–°æˆåŠŸ"
          echo "$body" | jq .
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "æ—¶é—´: ${{ steps.time.outputs.time }}"

